# AI OCR POC 프로젝트 작업 관리

## 프로젝트 개요
학습용 문제 이미지에 대해 AI 기반 OCR 기능을 테스트하는 웹 애플리케이션 개발

## 주요 기능 요구사항
1. 이미지 업로드/붙여넣기 기능
2. OpenAI API를 통한 JSON 결과 추출
3. JSON 결과를 HTML로 렌더링
4. 전문적인 UI/UX 구현

---

## 📋 작업 계획 및 진행 상황

### Phase 1: 기본 UI 구조 및 이미지 처리 (우선순위: 높음)
- [ ] **1.1 메인 페이지 UI 구조 설계**
  - UI.pdf 참고하여 레이아웃 구성
  - 이미지 업로드 영역, 결과 표시 영역, 컨트롤 버튼 영역 분리
  - 반응형 디자인 적용

- [ ] **1.2 이미지 업로드 컴포넌트 구현**
  - 파일 업로드 기능 (드래그 앤 드롭 지원)
  - 클립보드 이미지 붙여넣기 기능
  - 이미지 미리보기 및 삭제 기능
  - 이미지 크기 계산 (page_width_px, page_height_px)
  - 한 번에 하나의 이미지만 처리하도록 제한

- [ ] **1.3 전역 상태 관리 설정**
  - 이미지 상태, API 호출 상태, 결과 데이터 관리
  - 초기화 기능을 위한 상태 리셋 로직

### Phase 2: OpenAI API 연동 (우선순위: 높음) ✅ 완료
- ✅ **2.1 API Routes 구현**
  - `/api/ocr` - 이미지를 JSON으로 변환하는 엔드포인트
  - `/api/render` - JSON을 HTML로 렌더링하는 엔드포인트
  - API 키 보안 처리 (서버사이드에서만 사용)
  - OpenAI 클라이언트 라이브러리 설치 및 설정

- ✅ **2.2 OCR API 호출 로직**
  - system_prompt.txt와 user_prompt_template.txt 활용
  - 이미지를 base64로 인코딩하여 OpenAI Vision API 호출
  - Context window 크기 최적화 (max_tokens: 4000)
  - 에러 처리 및 로딩 상태 관리
  - 실제 API 호출로 더미 데이터 대체

- ✅ **2.3 HTML 렌더링 API 호출 로직**
  - html_render_system_prompt.txt 활용
  - JSON 결과를 HTML로 변환하는 API 호출
  - 렌더링된 HTML의 안전성 검증
  - 마크다운 코드 블록 제거 로직 추가

### Phase 3: 결과 표시 및 UI 개선 (우선순위: 중간) ✅ 완료
- ✅ **3.1 JSON 결과 표시 컴포넌트**
  - json.parser.online.fr 스타일의 JSON 뷰어 구현
  - 접기/펼치기 기능
  - 구문 하이라이팅
  - 복사 기능 (이미 구현됨)

- ✅ **3.2 HTML 렌더링 결과 표시**
  - 안전한 HTML 렌더링 (XSS 방지) - DOMPurify 적용
  - 스타일 격리
  - 반응형 레이아웃

- ✅ **3.3 UI 컨트롤 구현**
  - Send 버튼 (API 호출 트리거)
  - 초기화 버튼 (전체 상태 리셋)
  - 1회 호출 제한 로직 ("Demo에서는 1회만 호출됩니다" 메시지)

### Phase 4: 고급 기능 및 최적화 (우선순위: 낮음) ✅ 부분 완료
- ✅ **4.1 성능 최적화**
  - 이미지 압축 및 최적화 (2MB 이상 자동 압축)
  - 로딩 상태 개선 (단계별 진행 상태 표시)
  - API 응답 캐싱 (향후 구현 예정)

- ✅ **4.2 사용자 경험 개선**
  - 진행 상태 표시 (이미지 처리 단계별 표시)
  - 에러 메시지 개선
  - 키보드 단축키 지원 (향후 구현 예정)

- ✅ **4.3 배포 준비**
  - Vercel 배포 설정 (vercel.json 생성)
  - 환경 변수 설정 가이드 (README 업데이트)
  - 프로덕션 최적화

### Phase 5: 테스트 및 버그 수정 (우선순위: 중간) ✅ 완료
- ✅ **5.1 기능 테스트**
  - 이미지 업로드/붙여넣기 테스트
  - API 호출 및 응답 테스트 (타임아웃, 에러 처리 강화)
  - UI 인터랙션 테스트

- ✅ **5.2 브라우저 호환성 테스트**
  - DOMPurify 브라우저 호환성 개선
  - 메모리 누수 방지 (Object URL 정리)
  - ESLint 오류 수정

- ✅ **5.3 에러 처리 개선**
  - API 실패 시 대응 (AbortController, 타임아웃)
  - 네트워크 오류 처리 (상세 오류 메시지)
  - 사용자 피드백 개선 (단계별 로딩 상태)

### Phase 6: Vercel 배포 오류 해결 (우선순위: 높음) ✅ 완료
- ✅ **6.1 환경 변수 설정 문제 해결**
  - Vercel 프로젝트 설정에서 OPENAI_API_KEY 환경 변수 추가
  - 로컬 파일 기반 API 키 로딩 로직 개선
  - 환경 변수 검증 로직 강화

- ✅ **6.2 파일 시스템 접근 문제 해결**
  - Vercel 서버리스 환경에서 파일 읽기 제한 해결
  - 프롬프트 파일을 코드에 직접 포함하거나 환경 변수로 이동
  - 동적 파일 로딩 대신 정적 임포트 사용

- ✅ **6.3 API 엔드포인트 최적화**
  - Vercel 함수 타임아웃 설정 확인 (현재 60초)
  - 이미지 데이터 크기 제한 및 압축 로직 개선
  - 에러 로깅 및 디버깅 정보 강화

- ✅ **6.4 CORS 및 보안 설정**
  - Vercel 환경에서 CORS 설정 확인
  - API 키 보안 강화
  - 요청 검증 로직 개선

### Phase 7: 수식 렌더링 개선 (우선순위: 높음) ✅ 완료
- ✅ **7.1 수학 기호 처리 규칙 추가**
  - 근호 (³√, ⁴√) → HTML sup 태그로 변환
  - 첨자 (³, ⁴, ₃, ₄) → HTML sup/sub 태그로 변환
  - 수학 연산자 (÷, ×, ±, ≠, ≤, ≥) → HTML 엔티티 사용
  - 분수 표시를 위한 CSS 스타일 추가

- ✅ **7.2 MathJax 라이브러리 통합**
  - MathJax CDN 추가로 고급 수식 렌더링 지원
  - LaTeX 수식 표기법 지원
  - 인라인 및 블록 수식 처리 설정

- ✅ **7.3 HTML 렌더링 시스템 프롬프트 개선**
  - 수식 변환 규칙을 상세히 명시
  - 변환 예시 제공으로 AI 모델 이해도 향상
  - 테스트 모드에서도 수식 렌더링 적용

- ✅ **7.4 CSS 스타일 최적화**
  - 수학 기호 전용 폰트 설정
  - 첨자 크기 및 위치 조정
  - 분수 표시를 위한 스타일 클래스 추가

### Phase 8: OpenAI 모델 최적화 (우선순위: 높음) ✅ 완료
- ✅ **8.1 모델 분리 적용**
  - OCR API 엔드포인트: gpt-4o (이미지에서 JSON 추출)
  - HTML 렌더링 API 엔드포인트: gpt-4.1 (JSON에서 HTML 변환)
  - 각 작업에 최적화된 모델 사용

- ✅ **8.2 모델별 특화 성능 활용**
  - gpt-4o: Vision API를 통한 정확한 이미지 분석 및 텍스트 추출
  - gpt-4.1: 텍스트 처리에 특화된 고성능 모델로 HTML 렌더링 최적화
  - 각 모델의 장점을 활용한 효율적인 처리 파이프라인

### Phase 9: 빌드 오류 해결 (우선순위: 높음) ✅ 완료
- ✅ **9.1 정규식 오류 해결**
  - HTML 렌더링 시스템 프롬프트에서 JavaScript 정규식 충돌 해결
  - HTML 태그를 대괄호 형식으로 변경하여 구문 오류 방지
  - 수학 연산자를 HTML 엔티티로 변경

- ✅ **9.2 프롬프트 최적화**
  - 수식 변환 규칙을 JavaScript 호환 형식으로 수정
  - 빌드 프로세스에서 발생하는 구문 오류 완전 해결
  - Next.js 15.5.2 환경에서 안정적인 빌드 보장

### Phase 10: 수식 정규화 기능 추가 (우선순위: 높음) ✅ 완료
- ✅ **10.1 LaTeX 수식 정규화**
  - OCR 원문 수식을 LaTeX 형식으로 자동 변환
  - 근호, 지수, 분수, 연산자 등의 정규화 규칙 구현
  - JSON의 모든 text 필드에 text_latex 필드 추가

- ✅ **10.2 JSON 후처리 파이프라인**
  - JSON 파싱 후 자동으로 수식 정규화 적용
  - 재귀적 순회를 통한 모든 text 필드 처리
  - 실제 OpenAI API 응답에만 정규화 적용

### Phase 11: 테스트 모드 제거 (우선순위: 높음) ✅ 완료
- ✅ **11.1 OCR API 테스트 모드 제거**
  - 이미지 데이터 "test" 포함 조건 제거
  - 더미 데이터 반환 로직 완전 제거
  - 실제 OpenAI Vision API만 사용하도록 변경

- ✅ **11.2 HTML 렌더링 API 테스트 모드 제거**
  - JSON 데이터 "prob_016" ID 조건 제거
  - 더미 HTML 응답 반환 로직 완전 제거
  - 실제 OpenAI API만 사용하도록 변경

### Phase 12: HTML 렌더링 레이아웃 개선 (우선순위: 높음) ✅ 완료
- ✅ **12.1 Header 영역 제거**
  - 불필요한 헤더 섹션 완전 제거
  - "AI OCR 문제 분석 결과" 타이틀 제거
  - 깔끔한 콘텐츠 중심 레이아웃

- ✅ **12.2 2번 영역 확장화면 레이아웃 적용**
  - HtmlRenderer 컴포넌트 스타일과 일치하는 CSS 적용
  - container, content, renderFrame, renderedHtml 클래스 구조 적용
  - 반응형 디자인 및 다크모드 지원 스타일 포함

### Phase 13: 프롬프트 업데이트 (우선순위: 높음) ✅ 완료
- ✅ **13.1 OCR API 프롬프트 업데이트**
  - 표준 JSON(v1.1.0) 스키마 적용
  - text_raw, text_latex, text 필드 구조 적용
  - LaTeX 수식 정규화 규칙 포함
  - 한국어 OCR 원문 보존 강화

- ✅ **13.2 HTML 렌더링 API 프롬프트 업데이트**
  - 표준 JSON(v1.1.0) 렌더링 규칙 적용
  - 이미지 플레이스홀더 처리 로직 포함
  - text_latex 우선 사용 규칙 적용
  - 플레이스홀더 자동 축소 스크립트 포함

### Phase 14: 프롬프트 구조 최적화 (우선순위: 중간) ✅ 완료
- ✅ **14.1 OCR API 프롬프트 구조 개선**
  - 스키마 정의를 먼저 배치하여 가독성 향상
  - 핵심 규칙과 수식 정규화 규칙을 스키마 이후에 배치
  - 프롬프트 폴더의 최신 구조와 완전 일치

- ✅ **14.2 프롬프트 일관성 확보**
  - 모든 프롬프트가 프롬프트 폴더의 최신 내용과 동기화
  - 체계적인 구조로 AI 모델의 이해도 향상

### Phase 15: 프롬프트 간소화 (우선순위: 중간) ✅ 완료
- ✅ **15.1 OCR API 프롬프트 간소화**
  - "출력 스키마 v1.1.0 핵심 규칙" 섹션 제거
  - "수식 정규화 규칙" 섹션 제거
  - 프롬프트 폴더의 최신 간소화된 버전 적용

- ✅ **15.2 프롬프트 효율성 향상**
  - 불필요한 중복 내용 제거
  - 핵심 스키마와 규칙만 유지
  - AI 모델 처리 효율성 개선

---

## 📁 파일 구조 계획

```
app/
├── page.js                 # 메인 페이지
├── layout.js              # 루트 레이아웃
├── globals.css            # 전역 스타일
├── components/
│   ├── ImageUploader.js   # 이미지 업로드 컴포넌트
│   ├── JsonViewer.js      # JSON 결과 표시 컴포넌트
│   ├── HtmlRenderer.js    # HTML 렌더링 컴포넌트
│   └── ControlPanel.js    # 컨트롤 버튼들
├── api/
│   ├── ocr/
│   │   └── route.js       # OCR API 엔드포인트
│   └── render/
│       └── route.js       # HTML 렌더링 API 엔드포인트
└── styles/
    ├── components.module.css
    └── main.module.css
```

---

## 📊 진행 상황 요약

### 완료된 작업
- ✅ Next.js 프로젝트 초기 설정
- ✅ GitHub 저장소 연결
- ✅ 기본 프로젝트 구조 생성
- ✅ 작업 계획 수립
- ✅ **Phase 1.1: 메인 페이지 UI 구조 설계**
  - 메인 페이지 레이아웃 구성 (좌우 패널 구조)
  - 헤더, 푸터, 워크스페이스 영역 분리
  - 전문적인 그라데이션 디자인 적용
  - 반응형 디자인 및 다크 모드 지원
  - 단계별 진행 표시 (1,2,3 스텝 넘버링)
- ✅ **Phase 1.2: 이미지 업로드 컴포넌트 구현**
  - ImageUploader 컴포넌트 (드래그 앤 드롭, 클립보드 붙여넣기)
  - 이미지 메타데이터 추출 (크기, 용량, 형식)
  - 이미지 유효성 검사 및 에러 처리
  - 미리보기 및 삭제 기능
- ✅ **Phase 1.3: 전역 상태 관리 설정**
  - ControlPanel 컴포넌트 (Send, HTML 렌더링, 초기화 버튼)
  - JsonViewer 컴포넌트 (json.parser.online.fr 스타일)
  - HtmlRenderer 컴포넌트 (안전한 HTML 렌더링)
  - 진행 상태 관리 및 1회 호출 제한 로직
- ✅ **Phase 2: OpenAI API 연동 완료**
  - OCR API 엔드포인트 구현 (/api/ocr)
  - HTML 렌더링 API 엔드포인트 구현 (/api/render)
  - OpenAI Vision API 연동 (GPT-4o 모델 사용)
  - 이미지 base64 변환 및 메타데이터 처리
  - 실제 API 호출로 더미 데이터 대체
  - 에러 처리 및 응답 검증 로직
- ✅ **Phase 3: 결과 표시 및 UI 개선 완료**
  - JSON 뷰어 복사 기능 확인
  - HTML 렌더링 XSS 방지 강화 (DOMPurify 적용)
  - 안전한 HTML 태그 및 속성 필터링
- ✅ **Phase 4: 성능 최적화 및 배포 준비 완료**
  - 이미지 자동 압축 (2MB 이상 시 1920x1080, 80% 품질)
  - 단계별 로딩 상태 표시 (검증→압축→메타데이터→변환)
  - Canvas 기반 이미지 리사이징 및 품질 최적화
  - Vercel 배포 설정 및 환경 변수 가이드
- ✅ **Phase 5: 테스트 및 품질 보증 완료**
  - API 타임아웃 및 AbortController 적용
  - DOMPurify 브라우저 호환성 개선
  - 메모리 누수 방지 (Object URL 자동 해제)
  - ESLint 오류 수정 및 코드 품질 개선
  - 상세한 에러 메시지 및 사용자 피드백

### 완료된 추가 작업
- ✅ **UI 레이아웃 개선 (3단 구성)**
  - UI_ref.tsx 참고하여 가로 3단 구성으로 변경
  - 좌측: 문제 이미지 업로드 (노란색 배경)
  - 중앙: AI OCR 결과를 JSON 형식으로 확인 (하늘색 배경)
  - 우측: JSON 결과를 미리보기 형식으로 확인 (초록색 배경)
  - 반응형 디자인 적용 (1200px 이하에서 2단, 768px 이하에서 1단)

### 현재 상태
- ✅ **Vercel 배포 오류 해결 완료**
  - 환경 변수 설정 문제 해결
  - 파일 시스템 접근 제한 문제 해결
  - API 엔드포인트 최적화 완료
- ✅ **수식 렌더링 개선 완료**
  - 수학 기호 및 첨자 처리 규칙 추가
  - MathJax 라이브러리 통합
  - HTML 렌더링 시스템 프롬프트 개선
- ✅ **OpenAI 모델 최적화 완료**
  - OCR: gpt-4o (이미지 분석), HTML: gpt-4.1 (텍스트 처리)
  - 각 작업에 특화된 모델 사용으로 성능 최적화
  - 효율적인 처리 파이프라인 구축
- ✅ **빌드 오류 해결 완료**
  - JavaScript 정규식 충돌 문제 해결
  - HTML 렌더링 시스템 프롬프트 최적화
  - 안정적인 빌드 프로세스 보장
- ✅ **수식 정규화 기능 완료**
  - LaTeX 형식으로 자동 수식 변환
  - JSON 후처리 파이프라인 구축
  - 모든 text 필드에 text_latex 필드 추가
- ✅ **테스트 모드 제거 완료**
  - 모든 더미 데이터 반환 로직 제거
  - 실제 OpenAI API만 사용하도록 변경
  - 프로덕션 환경에 최적화된 코드 구성
- ✅ **HTML 렌더링 레이아웃 개선 완료**
  - 불필요한 헤더 영역 제거
  - 2번 영역 확장화면과 일치하는 레이아웃 적용
  - 깔끔하고 일관된 UI/UX 제공
- ✅ **프롬프트 업데이트 완료**
  - 표준 JSON(v1.1.0) 스키마 적용
  - LaTeX 수식 정규화 및 렌더링 규칙 강화
  - 이미지 플레이스홀더 처리 로직 포함
- ✅ **프롬프트 구조 최적화 완료**
  - 스키마 정의 우선 배치로 가독성 향상
  - 프롬프트 폴더와 완전 동기화
  - AI 모델 이해도 개선
- ✅ **프롬프트 간소화 완료**
  - 불필요한 중복 섹션 제거
  - 핵심 내용만 유지하여 효율성 향상
  - AI 모델 처리 속도 개선
- ✅ **프롬프트 최신화 및 모델 업데이트 완료**
  - html_render_system_prompt.txt 파일을 최신 내용으로 업데이트
  - HTML 렌더링 API에서 gpt-4.1 → gpt-4o 모델로 변경
  - OCR API는 이미 gpt-4o 모델 사용 중
  - 모든 API에서 최신 gpt-4o 모델 통일 적용
- ✅ **프롬프트 강화 완료**
  - 모든 API 프롬프트 맨 앞에 "중요한 문제이니 주의깊게 살펴보고 처리해줘" 문장 추가
  - OCR API: system_prompt.txt, user_prompt_template.txt, route.js 내 프롬프트 모두 업데이트
  - HTML 렌더링 API: html_render_system_prompt.txt, route.js 내 프롬프트 모두 업데이트
  - AI 모델의 주의력과 정확도 향상을 위한 프롬프트 강화 완료
- ✅ **API 초기화 강화 완료**
  - 모든 API 호출 시마다 완전한 초기화 보장
  - OpenAI 클라이언트: 매 호출마다 새로 생성
  - 메시지 배열: 매 호출마다 새로운 배열 생성
  - 프롬프트: 매 호출마다 새로 생성
  - 상세한 초기화 로그 추가로 디버깅 용이성 향상
- ✅ **모델 업그레이드 완료**
  - OpenAI API 모델을 gpt-4o → gpt-5-chat-latest로 업그레이드
  - OCR API: gpt-5-chat-latest 모델 적용
  - HTML 렌더링 API: gpt-5-chat-latest 모델 적용
  - 최신 GPT-5 Chat Latest 모델의 향상된 성능 활용
- ✅ **Phase 20: JSON 확장 화면 3가지 모드 구현 완료**
  - 확장 화면에서 format, json, overlay 3가지 모드 구현
  - Format 모드: JSON을 파싱하여 label과 input box로 구성된 셀 생성
  - Overlay 모드: 원본 이미지 위에 bbox 좌표 기반으로 박스 그리기
  - JSON 모드: 기존 JSON 뷰어와 동일한 기능 유지
  - 각 모드별 전용 CSS 스타일 및 UX 개선
  - Format 모드: 발문, 보기, 선택지 구조 파싱 및 choice_id 처리 개선
  - Overlay 모드: 영역1 업로드 이미지 사용 및 bbox 좌표 추출 로직 개선

### 배포 완료 상태
- 🚀 **GitHub 푸시 완료** (커밋: 2bf58e9)
- 📚 **문서화 완료** (GitHub 연동 배포 가이드)
- 🔍 **코드 품질 검증 완료** (ESLint 통과)
- 🛡️ **보안 강화 완료** (XSS 방지, API 키 보호)
- ⚡ **Vercel 배포 준비 완료** (vercel.json, 환경 변수 가이드)
- ✅ **Vercel 배포 오류 해결 완료** (환경 변수 및 파일 시스템 문제 해결)

---

## 📝 작업 로그

### 2024-01-XX
- ✅ 프로젝트 초기 설정 완료
- ✅ PRD 분석 및 작업 계획 수립 완료
- 📋 다음: UI 구조 설계 시작

### 2024-12-XX (현재)
- ✅ Vercel 배포 후 OCR 처리 오류 해결 완료
- ✅ Phase 6: Vercel 배포 오류 해결 작업 완료
- ✅ Phase 7: 수식 렌더링 개선 작업 완료
- ✅ Phase 8: OpenAI 모델 최적화 작업 완료
- ✅ Phase 9: 빌드 오류 해결 작업 완료
- ✅ Phase 10: 수식 정규화 기능 추가 작업 완료
- ✅ Phase 11: 테스트 모드 제거 작업 완료
- ✅ Phase 12: HTML 렌더링 레이아웃 개선 작업 완료
- ✅ Phase 13: 프롬프트 업데이트 작업 완료
- ✅ Phase 14: 프롬프트 구조 최적화 작업 완료
- ✅ Phase 15: 프롬프트 간소화 작업 완료
- ✅ Phase 16: 프롬프트 최신화 및 모델 업데이트 작업 완료
- ✅ Phase 17: 프롬프트 강화 작업 완료
- ✅ Phase 18: API 초기화 강화 작업 완료
- ✅ Phase 19: 모델 업그레이드 작업 완료
- ✅ Phase 20: JSON 확장 화면 3가지 모드 구현 작업 완료
- ✅ Phase 21: UI 레이아웃 개선 및 BBOX 매칭 문제 해결 작업 완료
- ✅ Phase 21.3: Overlay 모드 버튼 숨김 처리 작업 완료
- ✅ Phase 22: 3번 HTML 변환 영역 및 Overlay 모드 복원 작업 완료
- ✅ Phase 23: HTML 렌더링 제시문 영역 최소화 작업 완료
- 📋 다음: 프로덕션 환경에서 최종 테스트 및 모니터링

---

## 🔧 기술 스택 및 도구

### Frontend
- **Framework**: Next.js 15 (App Router)
- **Styling**: CSS Modules + Global CSS
- **State Management**: React useState/useContext
- **Image Processing**: Canvas API, File API

### Backend
- **API**: Next.js API Routes
- **AI Service**: OpenAI GPT-4 Vision API
- **File Handling**: FormData, Base64 encoding

### Deployment
- **Platform**: Vercel
- **Version Control**: GitHub

---

## ⚠️ 주의사항

1. **API 키 보안**: keys/api_key.txt는 .gitignore에 포함되어 있음
2. **Context Window**: OpenAI API 호출 시 컨텍스트 크기 주의
3. **1회 호출 제한**: Demo 버전에서는 Send 버튼 1회만 작동
4. **이미지 URL**: user_prompt_template에서 page_image_url은 'example.url' 고정값 사용
5. **초기화 기능**: 전체 상태 리셋 및 이전 컨텍스트 종료 필수
6. **Vercel 환경 변수**: OPENAI_API_KEY 환경 변수 설정 필수
7. **파일 시스템**: Vercel 서버리스 환경에서 파일 읽기 제한 있음

---

## 📞 참고 자료

- **PRD**: `/prd/prd.txt`
- **UI 디자인**: `/imgs/UI.pdf`
- **JSON 파서 예시**: `/imgs/json_parser_emxaple.png`
- **프롬프트 파일들**: `/prompt/` 디렉토리
- **API 키**: `/keys/api_key.txt`
- **Vercel 배포**: 환경 변수 설정 필요
